<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIChat æ•°å­—å¤§æ¨¡å‹èŠå¤©åŠ©æ‰‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="AIChat.ico" type="image/x-icon">
</head>
<body class="bg-slate-50 min-h-screen text-slate-900">

    <div class="max-w-3xl mx-auto px-4 py-8">
        <!-- å¤´éƒ¨å¡ç‰‡ -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 mb-6 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-indigo-600">AI Chat</h1>
                <p class="text-slate-400 text-sm">åŸºäºä¸ƒç‰›äº‘ AIGC æ¥å£ ----- å…¨æœå…±äº«å…è´¹æ¯æ—¥TOKENSæ€»é¢1000K</p>
            </div>
            <div class="text-right">
                <p class="text-xs text-slate-400 uppercase tracking-wider">Today's Tokens</p>
                <p id="usageCount" class="text-2xl font-mono font-bold text-emerald-500">0</p>
            </div>
        </div>

        <!-- è®¾ç½®åŒºåŸŸ -->
        <div class="space-y-3 mb-6">
            <!-- ç¬¬ä¸€è¡Œï¼šæ¨¡å‹é€‰æ‹©å’Œ ID è¾“å…¥ (4:6 æ¯”ä¾‹) -->
            <div class="flex flex-row gap-3">
                <select id="modelSelect" onchange="toggleCustomInput()" class="w-2/5 bg-white border border-slate-200 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-indigo-500 transition-all cursor-pointer">
                    <option value="deepseek/deepseek-v3.2-exp-thinking">DeepSeek-V3.2-Exp-Thinking</option>
                    <option value="qwen3-max-2026-01-23">åƒé—®3Max 2026 01 23</option>
                    <option value="z-ai/glm-4.7">GLM 4.7</option>
                    <option value="custom">-- è‡ªå®šä¹‰æ¨¡å‹ ID --</option>
                </select>
                <input id="customId" type="text" placeholder="å·²é”å®šå®˜æ–¹æ¨¡å‹" 
                    class="w-3/5 border border-slate-200 rounded-xl px-4 py-3 outline-none transition-all duration-300 bg-slate-100 text-slate-400 opacity-50 pointer-events-none" 
                    readonly>
            </div>

            <!-- ç¬¬äºŒè¡Œï¼šæ¸©åº¦ã€ä¸Šä¸‹æ–‡å’Œæ¸…é™¤æŒ‰é’® -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <!-- æ¸©åº¦è°ƒèŠ‚ -->
                <div class="flex items-center bg-white border border-slate-200 rounded-xl px-4 py-2 shadow-sm">
                    <!-- å¢åŠ  w-20 å›ºå®šå®½åº¦ï¼Œç¡®ä¿æ–‡å­—å¯¹é½ -->
                    <span class="text-xs text-slate-400 mr-2 whitespace-nowrap font-medium w-20">
                        æ¸©åº¦(<span id="tempValue" class="text-indigo-600">0.7</span>):
                    </span>
                    <!-- å¢åŠ  flex-1 è®©è¿›åº¦æ¡å æ®å‰©ä½™ç©ºé—´ï¼Œä½†é€šè¿‡ mx-2 ç¨å¾®ç¼©çŸ­ä¸¤ç«¯ -->
                    <input id="modelTemp" type="range" min="0" max="2" step="0.1" value="0.7" 
                        class="flex-1 h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600 mx-2" 
                        oninput="document.getElementById('tempValue').innerText=this.value">
                </div>
                
                <!-- ä¸Šä¸‹æ–‡é™åˆ¶ -->
                <div class="flex items-center bg-white border border-slate-200 rounded-xl px-4 py-2 shadow-sm">
                    <!-- åŒæ ·è®¾ç½® w-20 å›ºå®šå®½åº¦ï¼Œä¿æŒå·¦å³ä¸€è‡´ -->
                    <span class="text-xs text-slate-400 mr-2 whitespace-nowrap font-medium w-20">ä¸Šä¸‹æ–‡(è½®):</span>
                    <input id="maxContext" type="number" min="1" max="50" value="15" class="flex-1 outline-none text-sm bg-transparent">
                </div>
                
                <!-- æ¸…é™¤æŒ‰é’® -->
                <button onclick="clearChat()" class="bg-white text-red-500 border border-red-100 rounded-xl px-4 py-2 text-sm font-medium hover:bg-red-50 hover:border-red-200 transition-all shadow-sm">
                    ğŸ—‘ï¸ æ¸…é™¤å¯¹è¯è®°å½•
                </button>
            </div>
        </div>

        <!-- èŠå¤©çª—å£ -->
        <div id="chatWindow" class="bg-white border border-slate-200 rounded-2xl h-[500px] overflow-y-auto p-6 mb-6 space-y-4 shadow-inner">
            <div class="flex"><div class="bg-slate-100 px-4 py-2 rounded-2xl rounded-tl-none max-w-[85%] text-sm">æ‚¨å¥½ï¼è¯·é€‰æ‹©æ¨¡å‹å¹¶å¼€å§‹äº¤æµã€‚</div></div>
        </div>

        <!-- è¾“å…¥åŒºåŸŸ -->
        <div class="relative">
            <input id="userInput" type="text" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." class="w-full bg-white border border-slate-200 rounded-2xl pl-6 pr-24 py-4 shadow-lg outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
            <button onclick="handleSend()" id="sendBtn" class="absolute right-2 top-2 bottom-2 bg-indigo-600 text-white px-6 rounded-xl font-medium hover:bg-indigo-700 transition-colors">å‘é€</button>
        </div>
    </div>

    <script>
        const modelSelect = document.getElementById('modelSelect');
        const customId = document.getElementById('customId');
        const usageCount = document.getElementById('usageCount');
        const chatWindow = document.getElementById('chatWindow');
        const STORAGE_KEY = 'ai_chat_history'; 
    
        let chatHistory = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    
        window.onload = () => {
            if (chatHistory.length > 0) {
                chatWindow.innerHTML = ''; 
                chatHistory.forEach(msg => {
                    appendMsg(msg.content, msg.role === 'user' ? 'user' : 'ai');
                });
            }
            fetchUsage();
            toggleCustomInput(); // åˆå§‹åŒ–è¾“å…¥æ¡†çŠ¶æ€
        };
    
        function saveToLocal() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(chatHistory));
        }
    
        // æ§åˆ¶è‡ªå®šä¹‰è¾“å…¥æ¡†çš„æ˜¾ç¤ºä¸ç¦ç”¨çŠ¶æ€
        function toggleCustomInput() {
            const isCustom = modelSelect.value === 'custom';
            if (isCustom) {
                customId.readOnly = false;
                customId.classList.remove('bg-slate-100', 'text-slate-400', 'opacity-50', 'pointer-events-none');
                customId.classList.add('bg-white', 'text-slate-900', 'focus:ring-2', 'focus:ring-indigo-500');
                customId.placeholder = "è¯·è¾“å…¥æ¨¡å‹ ID";
                customId.focus();
            } else {
                customId.readOnly = true;
                customId.value = "";
                customId.classList.add('bg-slate-100', 'text-slate-400', 'opacity-50', 'pointer-events-none');
                customId.classList.remove('bg-white', 'text-slate-900', 'focus:ring-2', 'focus:ring-indigo-500');
                customId.placeholder = "ä»…è‡ªå®šä¹‰æ¨¡å‹IDå¯è¾“å…¥";
            }
        }
    
        async function fetchUsage() {
            try {
                const res = await fetch('api.php?action=usage');
                const data = await res.json();
                usageCount.innerText = (data.total || 0).toLocaleString() + "K";
            } catch (e) { usageCount.innerText = "Error"; }
        }
    
        async function handleSend() {
            const userInputElem = document.getElementById('userInput');
            const text = userInputElem.value.trim();
            let maxContext = parseInt(document.getElementById('maxContext').value) || 15;
            const temperature = parseFloat(document.getElementById('modelTemp').value);

            if (!text) return;
    
            const model = modelSelect.value === 'custom' ? customId.value : modelSelect.value;
            if (!model) { alert("è¯·æŒ‡å®šæ¨¡å‹ ID"); return; }
    
            if (chatHistory.length === 0) chatWindow.innerHTML = '';
    
            appendMsg(text, 'user');
            userInputElem.value = '';
            chatHistory.push({ role: "user", content: text });
            
            if (chatHistory.length > maxContext) chatHistory = chatHistory.slice(-maxContext);
            saveToLocal();
    
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.innerText = "...";
    
            // --- ä¿®æ”¹éƒ¨åˆ†ï¼šåˆå§‹åŒ–æ˜¾ç¤ºâ€œæ­£åœ¨æ€è€ƒä¸­â€ ---
            const aiMsgDiv = appendMsg("", 'ai');
            aiMsgDiv.innerHTML = '<i class="text-slate-400">æ­£åœ¨æ€è€ƒä¸­...</i>';
            let fullReply = "";
            let isFirstChunk = true; // ç”¨äºæ ‡è®°æ˜¯å¦æ˜¯æ¥æ”¶åˆ°çš„ç¬¬ä¸€ä¸ªæ•°æ®å—
            // ------------------------------------
    
            try {
                const response = await fetch('api.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        model: model, 
                        messages: chatHistory, 
                        stream: true,
                        temperature: temperature 
                    })
                });
    
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = "";
    
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();
    
                    for (const line of lines) {
                        const trimmed = line.trim();
                        if (!trimmed || trimmed === 'data: [DONE]') continue;
                        if (trimmed.startsWith('data: ')) {
                            try {
                                const json = JSON.parse(trimmed.substring(6));
                                const content = json.choices[0]?.delta?.content || "";
                                if (content) {
                                    // --- ä¿®æ”¹éƒ¨åˆ†ï¼šæ”¶åˆ°å†…å®¹åæ¸…é™¤â€œæ­£åœ¨æ€è€ƒä¸­â€ ---
                                    if (isFirstChunk) {
                                        aiMsgDiv.innerText = "";
                                        isFirstChunk = false;
                                    }
                                    // ---------------------------------------
                                    fullReply += content;
                                    aiMsgDiv.innerText = fullReply;
                                    chatWindow.scrollTop = chatWindow.scrollHeight;
                                }
                            } catch (e) { console.error("è§£æé”™è¯¯", e); }
                        }
                    }
                }
                chatHistory.push({ role: "assistant", content: fullReply });
                saveToLocal();
                fetchUsage();
            } catch (e) {
                aiMsgDiv.innerText = "é”™è¯¯ï¼šæ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨";
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerText = "å‘é€";
            }
        }

        
        function clearChat() {
            if (confirm("ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å¯¹è¯è®°å½•å—ï¼Ÿ")) {
                chatHistory = [];
                localStorage.removeItem(STORAGE_KEY);
                chatWindow.innerHTML = '';
                appendMsg("å¯¹è¯è®°å½•å·²æ¸…ç©ºï¼Œè¯·é‡æ–°å¼€å§‹äº¤æµã€‚", 'ai');
            }
        }
    
        function appendMsg(content, role) {
            const div = document.createElement('div');
            div.className = role === 'user' ? 'flex justify-end' : 'flex';
            const inner = document.createElement('div');
            inner.className = role === 'user' 
                ? 'bg-indigo-600 text-white px-4 py-2 rounded-2xl rounded-tr-none max-w-[85%] text-sm shadow-sm'
                : 'bg-slate-100 text-slate-800 px-4 py-2 rounded-2xl rounded-tl-none max-w-[85%] text-sm border border-slate-200';
            inner.innerText = content;
            div.appendChild(inner);
            chatWindow.appendChild(div);
            chatWindow.scrollTop = chatWindow.scrollHeight;
            return inner;
        }
    
        document.getElementById('userInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleSend();
        });
    </script>

</body>
</html>
